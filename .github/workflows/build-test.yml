name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ

on:
  push:
    branches-ignore: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# åŒã˜PRã«å¯¾ã™ã‚‹é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.js ${{ matrix.node-version }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: npm run compile

      - name: Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build

      - name: Firefoxæ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒ“ãƒ«ãƒ‰
        run: npm run build:firefox

      - name: ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ã‚’æ¤œè¨¼
        run: |
          # Chromeãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f ".output/chrome-mv3/manifest.json" ]; then
            echo "âŒ Chromeãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -f ".output/chrome-mv3/popup.html" ]; then
            echo "âŒ Chromeãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: popup.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -f ".output/chrome-mv3/background.js" ]; then
            echo "âŒ Chromeãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: background.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ ! -f ".output/chrome-mv3/content-scripts/content.js" ]; then
            echo "âŒ Chromeãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: content.js ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # Firefoxãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [ ! -f ".output/firefox-mv2/manifest.json" ]; then
            echo "âŒ Firefoxãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ: manifest.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "âœ… ã™ã¹ã¦ã®ãƒ“ãƒ«ãƒ‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"

      - name: ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“¦ ãƒ“ãƒ«ãƒ‰ã‚µã‚¤ã‚º:"
          echo "Chromeæ‹¡å¼µæ©Ÿèƒ½:"
          du -sh .output/chrome-mv3
          echo "Firefoxæ‹¡å¼µæ©Ÿèƒ½:"
          du -sh .output/firefox-mv2
          
          # CSSãŒæœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆPurgeCSSå¾Œã¯200KBä»¥ä¸‹ã«ãªã‚‹ã¹ãï¼‰
          CHROME_CSS_SIZE=$(find .output/chrome-mv3 -name "*.css" -exec du -b {} + | awk '{sum+=$1} END {print sum}')
          FIREFOX_CSS_SIZE=$(find .output/firefox-mv2 -name "*.css" -exec du -b {} + | awk '{sum+=$1} END {print sum}')
          
          echo "Chrome CSSåˆè¨ˆã‚µã‚¤ã‚º: ${CHROME_CSS_SIZE} ãƒã‚¤ãƒˆ"
          echo "Firefox CSSåˆè¨ˆã‚µã‚¤ã‚º: ${FIREFOX_CSS_SIZE} ãƒã‚¤ãƒˆ"
          
          if [ "$CHROME_CSS_SIZE" -gt 204800 ]; then  # 200KB in bytes
            echo "âš ï¸ Chrome CSSã‚µã‚¤ã‚ºãŒäºˆæƒ³ã‚ˆã‚Šå¤§ãã„ã§ã™ã€‚PurgeCSSãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
          fi
          
          if [ "$FIREFOX_CSS_SIZE" -gt 204800 ]; then  # 200KB in bytes
            echo "âš ï¸ Firefox CSSã‚µã‚¤ã‚ºãŒäºˆæƒ³ã‚ˆã‚Šå¤§ãã„ã§ã™ã€‚PurgeCSSãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
          fi

      - name: Chromeãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-build-node${{ matrix.node-version }}-${{ github.run_number }}
          path: .output/chrome-mv3/
          retention-days: 7

      - name: Firefoxãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension-build-node${{ matrix.node-version }}-${{ github.run_number }}
          path: .output/firefox-mv2/
          retention-days: 7

  lint-and-format:
    name: ãƒªãƒ³ãƒˆã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: TypeScriptå‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        run: npm run compile

      - name: æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
        run: |
          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„APIã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™..."
          
          # ä¸€èˆ¬çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™¤å¤–ã€ã“ã‚Œã‚‰ã¯æ­£å½“ã«secretsã‚’å‚ç…§ã™ã‚‹ãŸã‚ï¼‰
          if grep -r -i "api.key\|secret\|password\|token" --include="*.ts" --include="*.js" --exclude-dir="node_modules" --exclude-dir=".github" . | grep -v "// Safe:" | grep -v "# Safe:"; then
            echo "âš ï¸ æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¸Šè¨˜ã®ãƒãƒƒãƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "ã“ã‚Œã‚‰ãŒå®‰å…¨ãªå ´åˆã¯ã€'// Safe:' ã¾ãŸã¯ '# Safe:' ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ã“ã®è­¦å‘Šã‚’æŠ‘åˆ¶ã—ã¦ãã ã•ã„ã€‚"
          else
            echo "âœ… æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
          # eval()ã®ä½¿ç”¨ã‚’ãƒã‚§ãƒƒã‚¯
          if grep -r "eval(" --include="*.ts" --include="*.js" --exclude-dir="node_modules" .; then
            echo "âŒ eval()ã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - æ½œåœ¨çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã§ã™"
            exit 1
          else
            echo "âœ… eval()ã®ä½¿ç”¨ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

  comment-on-pr:
    name: PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
    runs-on: ubuntu-latest
    needs: [build-test, lint-and-format]
    if: github.event_name == 'pull_request'
    steps:
      - name: ãƒ“ãƒ«ãƒ‰æˆåŠŸã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼\n\n- TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«: âœ…\n- Chromeæ‹¡å¼µæ©Ÿèƒ½ãƒ“ãƒ«ãƒ‰: âœ…\n- Firefoxæ‹¡å¼µæ©Ÿèƒ½ãƒ“ãƒ«ãƒ‰: âœ…\n- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: âœ…\n\nãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚`
            });